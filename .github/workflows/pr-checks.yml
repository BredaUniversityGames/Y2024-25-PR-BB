name: PR-Checks

# For more info on the checks enabled see: https://clang.llvm.org/extra/clang-tidy/checks/list.html

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-project:
    name: Build and Test Project

    strategy:
      fail-fast: true
      matrix:
        platform: [ ubuntu-latest, windows-latest ]
        configuration: [ Debug, Release ]

    runs-on: ${{ matrix.platform }}

    env:
      OPTION_ARGS: -DWARNINGS_AS_ERRORS=ON -DCOMPILE_SHADERS=OFF -DENABLE_PCH=OFF -DUSE_UNITY_BUILD=ON
      COMPILER: -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
      PRESET_PREFIX: ${{ matrix.platform == 'windows-latest' && 'x64' || matrix.platform == 'ubuntu-latest' && 'WSL' }}
      PRESET_SUFFIX: ${{ matrix.configuration }}

    steps:
      # Check out project

      - name: Checkout Project
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      # Install all dependencies

      - name: Setup Ninja
        uses: ashutoshvarma/setup-ninja@master

      - name: Setup Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.0
        with:
          vulkan-query-version: latest
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true

      # Configure, Build and Test

      - name: Configure Project
        run: cmake --preset ${{ env.PRESET_PREFIX }}-${{ env.PRESET_SUFFIX }} ${{ env.COMPILER }} ${{ env.OPTION_ARGS }}

      - name: Build Project
        run: cmake --build build/${{ env.PRESET_PREFIX }}-${{ env.PRESET_SUFFIX }}

      - name: Test Project
        run: build/${{ env.PRESET_PREFIX }}-${{ env.PRESET_SUFFIX }}/UnitTests
          