name: Steam-Build-Upload

on:
  workflow_dispatch:
  pull_request:
    branches: [ "main" ]

jobs:
  build--and-upload-project:
    name: Build and Upload Project

    strategy:
      fail-fast: true
      matrix:
        platform: [ ubuntu-latest, windows-latest ]
        configuration: [ Release ]

    runs-on: ${{ matrix.platform }}

    env:
      OPTION_ARGS: -DWARNINGS_AS_ERRORS=ON -DCOMPILE_SHADERS=OFF -DENABLE_PCH=OFF -DENABLE_UNITY=OFF
      PRESET_PREFIX: ${{ matrix.platform == 'windows-latest' && 'x64' || matrix.platform == 'ubuntu-latest' && 'WSL' }}
      PRESET_SUFFIX: ${{ matrix.configuration }}

    steps:
      # Check out project

      - name: Checkout Project
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      # Install all dependencies

      - name: Setup Ninja
        uses: ashutoshvarma/setup-ninja@master

      - name: Setup Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.0
        with:
          vulkan-query-version: latest
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true

      # Configure and Build

      - name: Configure Project
        run: cmake --preset ${{ env.PRESET_PREFIX }}-${{ env.PRESET_SUFFIX }} ${{ env.OPTION_ARGS }}

      - name: Build Project
        run: cmake --build build/${{ env.PRESET_PREFIX }}-${{ env.PRESET_SUFFIX }}

      # Package project
      - name: Package Windows Project
        if: matrix.platform == `windows-latest`
        run: |
          scripts/build_system/package_dist_windows.bat

      - name: Package Linux Project
        if: matrix.platform == `ubuntu-latest`
        run: |
          scripts/build_system/package_dist_linux.bat
